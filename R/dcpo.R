#' Estimate Dynamic Comparative Public Opinion
#'
#' \code{dcpo} uses diverse survey data to estimate public opinion across countries and over time.
#'
#' @param x a data frame of survey items and marginals generated by \code{dcpo_setup}
#' @param scale_item a string specifying a question-cutpoint to identify the scale of the public opinion; this item will be assigned a difficulty of .5
#' @param seed an integer specifying the seed for random number generation for replication purposes
#' @param iter a positive integer specifying the number of iterations for each chain (including warmup)
#' @param chains a positive integer specifying the number of Markov chains; the default is 3
#' @param cores a positive integer specifying the number of processor cores to use; the default is the lesser of the number of chains or half the available cores
#' @param adapt_delta a double between 0 and 1; the default is .95.  Lower values complete faster at a greater risk of nonconvergence
#' @param chime play chime when complete?
#
#' @details \code{dcpo}, when passed a data frame \code{x} of survey marginals created by \code{dcpo_setup}, estimates a latent variable of public opinion.
#'
#' If a data frame of independent variables including observations for all countries that appear in \code{x} for each year in the time period from the first to last year to appear in \code{x} is passed to the argument \code{iv}, \code{dcpo} will also estimate coefficients for these predictors.
#'
#' @return a stanfit object
#'
#' @import rstan
#' @importFrom beepr beep
#' @importFrom dplyr "%>%" group_by summarize first
#' @importFrom reshape2 acast
#'
#' @export

dcpo <- function(x,
                 scale_item,
                 chime = TRUE,
                 ...) {


  unobs_years <- setdiff(min(x$year):max(x$year), unique(x$year)) # identify years that are completely unobserved in survey data

  # add dummy rows for completely unobserved years
  x_new <- bind_rows(x, x %>%
                       slice(1:length(unobs_years)) %>%
                       mutate(year = unobs_years,
                              n = 0))

  n_tkqr <- reshape2::acast(x_new,
                            year ~ country ~ item ~ r,
                            fun.aggregate = sum,
                            value.var = "n",
                            drop = FALSE)

  n_qr <- as.data.frame(apply(n_tkqr, c(3, 4), sum)) %>%
    tibble::rownames_to_column()

  unused_cp <- n_qr %>%
    dplyr::mutate_all(~if_else(. > 0, 0, 1)) %>%
    dplyr::select(-`1`, -rowname) %>%
    as.matrix()

  scale_q <- stringr::str_replace(scale_item, "_.*", "")
  scale_r <- stringr::str_replace(scale_item, ".*_", "")

  scale_item_matrix <- n_qr %>%
    janitor::clean_names() %>%
    dplyr::mutate_at(vars(matches(paste0("x\\d+$"))), ~if_else(. > 0, 10, 0)) %>%
    mutate_at(vars(matches(paste0("x", scale_r, "$"))), ~if_else(rowname == scale_q, . + 1, 0)) %>%
    dplyr::mutate_at(vars(matches(paste0("x\\d+$"))), ~if_else(. > 0, . - 10, 0)) %>%
    select(-rowname, -x1) %>%
    as.matrix()
  stopifnot(sum(scale_item_matrix) == 1)

  dcpo_data <- list(  K          = dplyr::n_distinct(x$country),
                      T          = max(x$year) - min(x$year) + 1,
                      Q          = dplyr::n_distinct(x$item),
                      R          = max(x$r),
                      N          = n_tkqr,
                      unused_cut = unused_cp,
                      fixed_cutp = scale_item_matrix,
                      N_nonzero  = length(which(n_tkqr != 0))
  )

  dcpo_model <- stanmodels$dcpo
  stan_args <- list(object = dcpo_model,
                    data = dcpo_data,
                    ...)
  if (!length(stan_args$control)) {
    stan_args$control <- list(max_treedepth = 12)
  }
  if (!length(stan_args$init_r)) {
    stan_args$init_r <- 1L
  }
  if (!length(stan_args$seed)) {
    stan_args$seed <- 324
  }
  if (!length(stan_args$cores)) {
    stan_args$cores <- min(chains, parallel::detectCores()/2)
  }
  out1 <- do.call(rstan::sampling, stan_args)

  # Chime
  if(chime) {
    beep()
  }

  return(out1)
}
