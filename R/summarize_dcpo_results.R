#' Summarize DCPO Results
#'
#' \code{summarize_dcpo_results} is a convenience function that produces summary statistics of the main parameters of a DCPO stanfit object along with the relevant identifying information (country, year, question, and cutpoint).
#'
#' @param dcpo_input the data frame of survey items and marginals generated by \code{DCPOtools::dcpo_setup} previously passed to \code{DCPO::dcpo} to generate the stanfit object passed as \code{dcpo_output}
#' @param dcpo_output a stanfit object output by \code{DCPO::dcpo}
#' @param pars a character vector of parameter names to be summarized from the \code{DCPO} model: theta (mean public opinion), sigma (polarization in public opinion), alpha (question dispersion), beta (question-cutpoint difficulty), and/or delta (country-specific question bias)
#' @param probs a numeric vector of quantiles of interest; the default is c(.1, .9)
#'
#' @examples
#' \donttest{
#' out1 <- dcpo(demsup_data,
#'              chime = FALSE,
#'              chains = 1,
#'              iter = 300) # 1 chain/300 iterations for example purposes only; use defaults
#'
#' theta_results <- summarize_dcpo_results(dcpo_input = demsup_data,
#'                                         dcpo_output = out1,
#'                                         pars = "theta")
#' }
#'
#' @return a tibble
#'
#' @importFrom rstan summary
#' @importFrom dplyr mutate group_by summarize select first arrange
#' @importFrom purrr map_df
#' @importFrom tibble as_tibble rownames_to_column
#'
#' @export

summarize_dcpo_results <- function(dcpo_input,
                                 dcpo_output,
                                 pars = c("theta", "sigma", "alpha", "beta", "delta"),
                                 probs = c(.1, .9)) {

  question <- country <- year <- parameter <- kk <- tt <- qq <- rr <- NULL

  dat <- dcpo_input$data

  fit <- dcpo_output

  qcodes <- dat %>%
    dplyr::group_by(question) %>%
    filter(rr == max(rr)) %>%
    dplyr::summarize(qq = first(qq) %>%
                       as.numeric(),
                     n = n(),
                     rr_max = max(rr))

  kcodes <- dat %>%
    dplyr::group_by(country) %>%
    dplyr::summarize(kk = first(kk) %>%
                       as.numeric())

  tcodes <- dat %>%
    dplyr::group_by(year) %>%
    dplyr::summarize(tt = first(tt))


  ktcodes <- dat %>%
    dplyr::group_by(country) %>%
    dplyr::summarize(first_yr = min(year),
                     last_yr = max(year))

  res <- map_df(pars, function(par) {
    if (par == "theta") {
      fit$summary("theta",
                  ~posterior::quantile2(., probs = probs),
                  posterior::default_summary_measures()) %>%
        dplyr::mutate(tt = as.numeric(gsub("theta\\[(\\d+),\\d+\\]",
                                           "\\1",
                                           variable)),
                      kk = as.numeric(gsub("theta\\[\\d+,(\\d+)\\]",
                                           "\\1",
                                           variable))) %>%
        dplyr::left_join(kcodes, by = "kk") %>%
        dplyr::left_join(tcodes, by = "tt") %>%
        dplyr::mutate(year = if_else(tt == 1,
                                     as.integer(year),
                                     as.integer(min(year, na.rm = TRUE) + tt - 1))) %>%
        dplyr::left_join(ktcodes, by = "country") %>%
        dplyr::filter(year >= first_yr & year <= last_yr) %>%
        dplyr::arrange(kk, tt) %>%
        dplyr::select(country, year, mean, median, sd, mad, q5, q10, q90, q95, variable, kk, tt)
    } else if (par == "sigma") {
      fit$summary("theta",
                  ~posterior::quantile2(., probs = probs),
                  posterior::default_summary_measures()) %>%
        dplyr::mutate(tt = as.numeric(gsub("sigma\\[(\\d+),\\d+\\]",
                                           "\\1",
                                           variable)),
                      kk = as.numeric(gsub("sigma\\[\\d+,(\\d+)\\]",
                                           "\\1",
                                           variable))) %>%
        dplyr::left_join(kcodes, by = "kk") %>%
        dplyr::left_join(tcodes, by = "tt") %>%
        dplyr::mutate(year = if_else(tt == 1,
                                     as.integer(year),
                                     as.integer(min(year, na.rm = TRUE) + tt - 1))) %>%
        dplyr::left_join(ktcodes, by = "country") %>%
        dplyr::filter(year >= first_yr & year <= last_yr) %>%
        dplyr::arrange(kk, tt) %>%
        dplyr::select(country, year, mean, median, sd, mad, q5, q10, q90, q95, variable, kk, tt)
    } else if (par == "alpha") {
      fit$summary("alpha") %>%
        dplyr::mutate(qq = as.numeric(gsub("alpha\\[(\\d+)]",
                                           "\\1",
                                           variable))) %>%
        dplyr::left_join(qcodes, by = "qq") %>%
        dplyr::arrange(qq) %>%
        dplyr::select(question, n, everything())
    } else if (par == "beta") {
      fit$draws("beta", format = "df") %>%
        dplyr::mutate(rr = as.numeric(gsub("beta\\[(\\d+),\\d+\\]",
                                           "\\1",
                                           variable)),
                      qq = as.numeric(gsub("beta\\[\\d+,(\\d+)\\]",
                                           "\\1",
                                           variable)))%>%
        dplyr::left_join(qcodes, by = "qq") %>%
        dplyr::arrange(qq, rr) %>%
        dplyr::filter(rr <= rr_max) %>%
        dplyr::select(question, n, everything())
    } else if (par == "delta") {
      fit$draws("delta", format = "df") %>%
        dplyr::mutate(qq = as.numeric(gsub("delta\\[(\\d+),\\d+\\]",
                                           "\\1",
                                           parameter)),
                      kk = as.numeric(gsub("delta\\[\\d+,(\\d+)\\]",
                                           "\\1",
                                           parameter)))%>%
        dplyr::left_join(qcodes, by = "qq") %>%
        dplyr::left_join(kcodes, by = "kk") %>%
        dplyr::arrange(qq) %>%
        dplyr::select(question, n, country, everything())
    }
  })
  return(res)
}
